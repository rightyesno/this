<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>about: blank</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { position: relative; }
        textarea, .highlightedText {
            width: 100%;
            height: 200px;
            padding: 10px;
            font-size: 16px;
            font-family: inherit;
            line-height: 1.5;
        }
        textarea { 
            position: absolute; 
            top: 0; 
            left: 0; 
            background: transparent; 
            z-index: 1; 
            color: transparent; 
            caret-color: black; /* Only caret visible */
        }
        .highlightedText {
            white-space: pre-wrap; /* Preserve whitespace and newlines */
            word-wrap: break-word; /* Ensure long words break */
            z-index: 0;
        }
        .highlight { background-color: yellow; }
        #results { margin-top: 20px; }
        #aiSuggestions { margin-top: 20px; font-style: italic; }
    </style>
</head>
<body>

<h1>Advanced Grammar and Punctuation Checker</h1>

<div class="container">
    <textarea id="textInput" placeholder="Type or paste your text here..." oninput="syncText()"></textarea>
    <div class="highlightedText" id="highlightedText"></div>
</div>
<br>
<button onclick="checkGrammar()">Check Text</button>

<div id="results"></div>
<div id="aiSuggestions"></div>

<script>
    function syncText() {
        const text = document.getElementById("textInput").value;
        document.getElementById("highlightedText").textContent = text; // Initially without highlighting
    }

    function checkGrammar() {
        const text = document.getElementById("textInput").value;

        // Send a request to LanguageTool API
        fetch("https://api.languagetool.org/v2/check", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `text=${encodeURIComponent(text)}&language=en-US`,
        })
        .then(response => response.json())
        .then(data => {
            const highlightedTextDiv = document.getElementById("highlightedText");
            const resultsDiv = document.getElementById("results");
            const aiSuggestionsDiv = document.getElementById("aiSuggestions");

            let highlightedText = text;
            let offsetAdjustment = 0;

            resultsDiv.innerHTML = '';  // Clear previous results
            aiSuggestionsDiv.innerHTML = '';  // Clear previous suggestions

            // Process and highlight grammar/spelling errors
            if (data.matches.length > 0) {
                data.matches.forEach((match, index) => {
                    const start = match.offset + offsetAdjustment;
                    const end = start + match.length;
                    const errorSnippet = text.slice(match.offset, match.offset + match.length);

                    // Highlight the error in the text using a span
                    highlightedText = highlightedText.substring(0, start) + 
                                      `<span class="highlight">${highlightedText.substring(start, end)}</span>` + 
                                      highlightedText.substring(end);

                    // Adjust offset for added span tags
                    offsetAdjustment += `<span class="highlight"></span>`.length;

                    // Create a detailed issue display
                    const line = text.substr(0, match.offset).split('\n').length; // Get line number
                    const issue = document.createElement("p");
                    issue.innerHTML = `<strong>Issue ${index + 1}:</strong> ${match.message}<br>
                                       <strong>Error:</strong> "${errorSnippet}"<br>
                                       <strong>Line:</strong> ${line}<br>
                                       <strong>Position:</strong> Character ${match.offset} to ${match.offset + match.length}<br>
                                       <strong>Suggestion:</strong> ${match.replacements.map(r => r.value).join(", ")}`;
                    resultsDiv.appendChild(issue);
                });
            } else {
                resultsDiv.innerHTML = "<p>No grammar or spelling issues found.</p>";
            }

            // Always check for punctuation issues
            const punctuationIssues = checkForPunctuationIssues(text);
            if (punctuationIssues.length > 0) {
                punctuationIssues.forEach(issue => {
                    const issueElement = document.createElement("p");
                    issueElement.innerHTML = issue;
                    resultsDiv.appendChild(issueElement);
                });
            }

            // Check for additional grammar rules
            const grammarIssues = checkForGrammarRules(text);
            if (grammarIssues.length > 0) {
                grammarIssues.forEach(issue => {
                    const issueElement = document.createElement("p");
                    issueElement.innerHTML = issue;
                    resultsDiv.appendChild(issueElement);
                });
            }

            // Check for indentation issues
            const indentationIssues = checkForIndentationIssues(text);
            if (indentationIssues.length > 0) {
                indentationIssues.forEach(issue => {
                    const issueElement = document.createElement("p");
                    issueElement.innerHTML = issue;
                    resultsDiv.appendChild(issueElement);
                });
            }

            // AI Suggestion: Improving style or rephrasing
            const smartSuggestion = generateSmartSuggestions(text, data.matches);
            aiSuggestionsDiv.innerHTML = `<strong>AI Suggestion:</strong> ${smartSuggestion}`;
        })
        .catch(error => {
            console.error("Error:", error);
            document.getElementById("results").innerHTML = "<p>Error occurred while checking text.</p>";
        });
    }

    function checkForPunctuationIssues(text) {
        const issues = [];
        const sentences = text.split(/(?<=[.!?])/).map(sentence => sentence.trim()).filter(Boolean);

        // Check for missing final punctuation in sentences
        sentences.forEach(sentence => {
            const lastChar = sentence.slice(-1);
            if (![".", "!", "?"].includes(lastChar)) {
                issues.push(`The sentence "${sentence}" may be missing punctuation at the end.`);
            }

            const questionWords = /^(what|how|why|where|is|are|do|does|can|could|would|should|who)\s/i;
            const isQuestion = questionWords.test(sentence);

            if (lastChar === '?' && !isQuestion) {
                issues.push(`The sentence "${sentence}" appears to be a statement but ends with a question mark.`);
            } else if (isQuestion && lastChar === '.') {
                issues.push(`Consider changing the period to a question mark in: "${sentence}".`);
            }
        });

        sentences.forEach(sentence => {
            const clauses = sentence.split(",").map(clause => clause.trim());
            if (clauses.length > 1 && clauses.some(clause => clause.includes("and") || clause.includes("but"))) {
                issues.push(`Check for possible comma splice in this sentence: "${sentence}"`);
            }

            const commaCount = (sentence.match(/,/g) || []).length;
            if (commaCount > 2) {
                issues.push(`Consider reviewing your comma usage in the sentence: "${sentence}"`);
            }

            const introductoryPhrases = /^(although|because|if|when|while|after|before|since|despite|in order to|to|as|for)\s/i;
            if (introductoryPhrases.test(sentence) && !sentence.includes(',')) {
                issues.push(`Consider adding a comma after the introductory phrase in: "${sentence}"`);
            }
        });

        const questionMarks = (text.match(/\?/g) || []).length;
        const exclamationMarks = (text.match(/!/g) || []).length;
        if (questionMarks > 1) {
            issues.push("Too many question marks detected. Consider rephrasing.");
        }
        if (exclamationMarks > 1) {
            issues.push("Too many exclamation marks detected. Consider rephrasing.");
        }

        return issues;
    }

    // Additional grammar rule checks
    function checkForGrammarRules(text) {
        const issues = [];

        // Check for subject-verb agreement (very basic check)
        const subjectVerbAgreementRegex = /\b(I|he|she|it|they|we|you)\s+(is|are)\b/gi;
        const agreementMatches = text.match(subjectVerbAgreementRegex);
        if (agreementMatches) {
            agreementMatches.forEach(match => {
                if (match.includes("are") && ["I", "he", "she", "it"].includes(match.split(" ")[0])) {
                    issues.push(`Incorrect subject-verb agreement: "${match}". Use "is" instead of "are".`);
                } else if (match.includes("is") && ["they", "we", "you"].includes(match.split(" ")[0])) {
                    issues.push(`Incorrect subject-verb agreement: "${match}". Use "are" instead of "is".`);
                }
            });
        }

        // Check for run-on sentences
        const runOnSentenceRegex = /(\w+,\s+)(and|but|or|nor)(\s+\w+)/g;
        const runOnMatches = text.match(runOnSentenceRegex);
        if (runOnMatches) {
            runOnMatches.forEach(match => {
                issues.push(`Possible run-on sentence detected: "${match}". Consider breaking it into two sentences.`);
            });
        }

        // Check for commonly confused words
        const commonlyConfusedWords = {
            "their": "there, they're",
            "its": "it's",
            "to": "too, two",
            "your": "you're",
            "than": "then"
        };

        Object.keys(commonlyConfusedWords).forEach(word => {
            const regex = new RegExp(`\\b${word}\\b`, 'gi');
            if (text.match(regex)) {
                issues.push(`Check the usage of "${word}". It may be confused with: ${commonlyConfusedWords[word]}`);
            }
        });

        return issues;
    }

    function checkForIndentationIssues(text) {
        const issues = [];
        const lines = text.split('\n');

        lines.forEach((line, index) => {
            const trimmedLine = line.trim();
            if (trimmedLine && line.startsWith(' ')) {
                issues.push(`Line ${index + 1} has leading spaces. Consider removing the indent.`);
            }
            // Additional checks for new paragraphs could be added here.
        });

        return issues;
    }

    function generateSmartSuggestions(text, matches) {
        const suggestions = [];
        const wordCount = text.split(' ').length;

        // Check for clarity and complexity
        if (wordCount > 20) {
            suggestions.push("Consider breaking long sentences into smaller ones for clarity.");
        }
        if (matches.length > 3) {
            suggestions.push("You have multiple issues. Consider revising the entire text for coherence.");
        }

        // Suggest on tone/formality
        if (/^(hey|hi|hello|what's up)/i.test(text)) {
            suggestions.push("Your text has an informal tone. Consider making it more formal if necessary.");
        }

        if (/^(i think|i believe|i feel)/i.test(text)) {
            suggestions.push("Consider providing more evidence or examples to support your opinion.");
        }

        // Suggest overall structure
        const paragraphCount = text.split('\n').filter(paragraph => paragraph.trim()).length;
        if (paragraphCount > 5) {
            suggestions.push("Your text has multiple paragraphs. Ensure each paragraph has a clear main idea.");
        }

        return suggestions.length > 0 ? suggestions.join(" ") : "Your writing looks good!";
    }
</script>

</body>
</html>
